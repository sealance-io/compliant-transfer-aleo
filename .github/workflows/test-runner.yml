name: Test Runner

on:
  workflow_call:
    inputs:
      test-file:
        description: 'Test file to run (or "all" for all tests)'
        required: true
        type: string
      mode:
        description: "devnet or devnode"
        required: true
        type: string
    secrets:
      GH_TOKEN:
        description: "GitHub token for container registry access"
        required: true

# No default permissions - jobs must explicitly request what they need
permissions: {}

jobs:
  run-tests:
    runs-on: ubuntu-latest
    env:
      TESTNET_ENDPOINT: "http://localhost:3030"
    permissions:
      contents: read
      packages: read # Pull container images from GHCR
      actions: read # Access workflow cache (setup-leo-action)
    timeout-minutes: 180
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          persist-credentials: false

      - name: Setup Leo CLI
        id: setup-leo
        uses: sealance-io/setup-leo-action@e0c5065dc5aab7edcc8b137369637c669c772b09 # v1.0.0-rc.2
        with:
          version: "3.4.0"
          rust-version: "1.90.0"
          enable-cache: true
          cache-save: ${{ github.ref == 'refs/heads/main' && 'always' || 'never' }}
          run-audit: true
          audit-deny-warnings: false

      - name: Verify Leo installation
        run: |
          leo --version
          echo "Cache hit (binary): $CACHE_HIT_BINARY"
          echo "Build time: ${BUILD_TIME_SECONDS}s"
        env:
          CACHE_HIT_BINARY: ${{ steps.setup-leo.outputs.cache-hit-binary }}
          BUILD_TIME_SECONDS: ${{ steps.setup-leo.outputs.build-time-seconds }}

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version-file: ".nvmrc"
          cache: "npm"
          cache-dependency-path: "./package-lock.json"

      - name: Install dokojs CLI
        env:
          NPM_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          npm config set @sealance-io:registry https://npm.pkg.github.com
          npm config set "//npm.pkg.github.com/:_authToken" "$NPM_TOKEN"
          npm install -g @sealance-io/dokojs@1.0.0 --ignore-scripts
          dokojs --version

      - run: cp .env.example .env

      # Note: Lockfile validation happens in caller workflow's linter job
      # Not duplicated here to avoid running with GITHUB_TOKEN in environment
      - name: Install dependencies
        run: npm ci --prefer-offline --ignore-scripts --no-audit --no-fund

      - name: Run npm audit
        run: npm audit --audit-level=high

      - name: Run postinstall
        run: npm run postinstall

      - name: Compile Leo programs
        run: npm run compile

      - name: Run tests
        run: |
          if [ "$TEST_FILE" = "all" ]; then
            npm test
          else
            npm run test:select "./test/$TEST_FILE"
          fi
        env:
          TEST_FILE: ${{ inputs.test-file }}
          DOCKER_HOST: "unix:///var/run/docker.sock"
          TESTCONTAINERS_RYUK_DISABLED: true
          USE_TEST_CONTAINERS: 1
          VITEST_HOOK_TIMING: true
          VITEST_TEST_MARKERS: true
          DEVNET: ${{ inputs.mode == 'devnet' }}
          CONSENSUS_VERSION: 12
          CONSENSUS_VERSION_HEIGHTS: "0,1,2,3,4,5,6,7,8,9,10,11"
