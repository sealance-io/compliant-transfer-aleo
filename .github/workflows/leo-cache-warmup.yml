name: Leo CLI Cache Warmup

on:
  schedule:
    # Run every Saturday at 11 PM UTC (before work week)
    - cron: "0 23 * * 6"
  workflow_dispatch:
    inputs:
      force-rebuild:
        description: "Force rebuild even if cache exists"
        type: boolean
        default: false

# No default permissions - jobs must explicitly request what they need
permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  warmup-cache:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write # Required for cache operations
    timeout-minutes: 30
    defaults:
      run:
        shell: bash -eo pipefail {0}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup Leo CLI (Cache Warmup)
        id: setup-leo
        uses: sealance-io/setup-leo-action@126611b39ce92d063c50da6623f8a0b08bf294dd # v1.0.0
        with:
          version: "3.4.0"
          rust-version: "1.90.0"
          enable-cache: true
          cache-save: always # Always save to ensure cache is refreshed
          run-audit: true
          audit-deny-warnings: false

      - name: Report cache status
        run: |
          {
            echo "## Leo CLI Cache Warmup Summary"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Leo Version | 3.4.0 |"
            echo "| Rust Version | 1.90.0 |"
            echo "| Cache Hit (Binary) | $CACHE_HIT_BINARY |"
            echo "| Build Time | ${BUILD_TIME_SECONDS}s |"
            echo ""
            if [ "$CACHE_HIT_BINARY" = "true" ]; then
              echo "Cache was already warm - refreshed for another 7 days"
            else
              echo "Cache miss - Leo was compiled from source and cached"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
        env:
          CACHE_HIT_BINARY: ${{ steps.setup-leo.outputs.cache-hit-binary }}
          BUILD_TIME_SECONDS: ${{ steps.setup-leo.outputs.build-time-seconds }}

      - name: Verify Leo installation
        run: leo --version
