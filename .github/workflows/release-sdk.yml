name: Release SDK

on:
  push:
    branches:
      - main
    paths:
      - 'packages/policy-engine-sdk/**'
      - "!packages/policy-engine-sdk/**/*.md"
      - "!packages/policy-engine-sdk/test/**"
      - "!packages/policy-engine-sdk/examples/**"
      - '.changeset/**'

# Prevent concurrent releases
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions: {} # no permissions by default

jobs:
  release:
    name: Release SDK
    runs-on: ubuntu-latest
    environment:
      name: npm-publish
    permissions:
      contents: write        # Create releases and tags
      pull-requests: write   # Create/update Version Packages PR
      id-token: write        # OIDC token for npm trusted publishing
      packages: write        # Publish to GitHub Packages

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          # Note: fetch-depth: 0 is NOT needed - changesets auto-deepens shallow clones as necessary
          # Using default shallow clone (fetch-depth: 1) for better security and performance
          persist-credentials: false  # Prevent credential leakage in artifacts

      # Configures for 'registry.npmjs.org' with OIDC for trusted publishing
      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version-file: '.nvmrc'
          # cache: 'npm'  # Disabled to prevent cache poisoning attacks in release workflow
          registry-url: 'https://registry.npmjs.org'

      # OIDC requires npm >= 11.5.1
      # Node.js 24 ships with npm 11.x (already OIDC-compatible)
      # This step is optional but kept for safety to ensure latest npm with cooldown policy
      - name: Upgrade npm for OIDC support
        run: npm install -g npm@latest --before="$(date -v -14d)"

      - name: Install dependencies
        run: npm ci --prefer-online --ignore-scripts

      - name: Run npm audit
        run: npm audit --audit-level=high

      - name: Build SDK
        run: npm run build --workspace=@sealance-io/policy-engine-aleo

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@e0145edc7d9d8679003495b11f87bd8ef63c0cba  # v1.5.3
        with:
          # Commands
          version: npx changeset version
          publish: npx changeset publish # publish to npmjs
          commit: 'chore: version packages'
          title: 'chore: version packages'
          createGithubReleases: false # we create gh release manually after publishing to github packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Reconfigures for 'npm.pkg.github.com' with NODE_AUTH_TOKEN auth
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        if: steps.changesets.outputs.published == 'true' # Only runs when packages are published (not on Version PR creation)
        with:
          node-version-file: '.nvmrc'
          # cache: 'npm'  # Disabled to prevent cache poisoning attacks in release workflow
          registry-url: 'https://npm.pkg.github.com'
          scope: '${{ github.repository_owner }}'
      
      - name: Publish to GitHub Packages
        if: steps.changesets.outputs.published == 'true' # Only runs when packages are published (not on Version PR creation)
        working-directory: packages/policy-engine-sdk
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create GitHub Release with changelog
      - name: Create GitHub Release
        if: steps.changesets.outputs.published == 'true' # Only runs when packages are published (not on Version PR creation)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ fromJson(steps.changesets.outputs.publishedPackages)[0].version }}
          CHANGELOG: ${{ steps.changesets.outputs.changelog }}
        # Uses the built-in gh CLI
        run: |
          TAG="policy-engine-sdk-v${VERSION}"
          gh release create "$TAG" \
            --title "SDK v${VERSION}" \
            --notes "${CHANGELOG}"