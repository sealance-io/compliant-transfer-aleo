name: Aleo Program Tests

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**/*.md'

concurrency:
  group: ci-tests-${{ github.ref }}-1
  cancel-in-progress: true

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      # temporarily allow only manual runs
      should_run: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - run: echo "Checking if workflow was manually triggered"

  merkle-tree-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.should_run == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Merkle Tree Test"
      test_command: "npm run test:select ./test/merkle_tree.test.ts"
      watched_paths: "programs/rediwsozfo_v2.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  compliant-transfer-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.should_run == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Compliant Transfer Test"
      test_command: "npm run test:select ./test/compliant_transfer_v0.test.ts"
      watched_paths: "programs/tqxftxoicd_v2.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  freeze-registry-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.should_run == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Freeze Registry Test"
      test_command: "npm run test:select ./test/freeze_registry.test.ts"
      watched_paths: "programs/freeze_registry.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  timelock-policy-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.should_run == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Timelock Policy Test"
      test_command: "npm run test:select ./test/timelock.test.ts"
      watched_paths: "programs/compliant_timelock_transfer.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  threshold-policy-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.should_run == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Threshold Policy Test"
      test_command: "npm run test:select ./test/compliant_threshold_transfer.test.ts"
      watched_paths: "programs/compliant_threshold_transfer.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit
