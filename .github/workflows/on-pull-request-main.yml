name: Aleo Program Tests

on:
  workflow_dispatch:
    inputs:
      run_merkle_tree:
        description: "Run Merkle Tree tests"
        type: boolean
        default: true
      run_report_policy:
        description: "Run Sealed Report Policy tests"
        type: boolean
        default: true
      run_freeze_registry:
        description: "Run Freeze Registry tests"
        type: boolean
        default: true
      run_timelock_policy:
        description: "Run Timelock Policy tests"
        type: boolean
        default: true
      run_threshold_policy:
        description: "Run Threshold Policy tests"
        type: boolean
        default: true
      run_exchange:
        description: "Run Exchange tests"
        type: boolean
        default: true
      run_sealed_report_token:
        description: "Run Sealed Report Token tests"
        type: boolean
        default: true
      run_standalone_report_token:
        description: "Run Sealed Standalone Token tests"
        type: boolean
        default: true
  pull_request:
    branches:
      - main
    paths-ignore:
      - "**/*.md"

concurrency:
  group: ci-tests-${{ github.ref }}-1
  cancel-in-progress: true

jobs:
  linter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
      - uses: actions/setup-node@v4.4.0
        with:
          cache: "npm"
          node-version-file: ".nvmrc"
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit --no-fund --ignore-scripts && npm run postinstall
      - name: Run prettier
        run: npm run format
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      run_merkle_tree: >-
        ${{ 
          github.event_name == 'workflow_dispatch' && inputs.run_merkle_tree || 
          github.event_name == 'pull_request' && false
        }}
      run_report_policy: >-
        ${{ 
          github.event_name == 'workflow_dispatch' && inputs.run_report_policy || 
          github.event_name == 'pull_request' && false
        }}
      run_freeze_registry: >-
        ${{ 
          github.event_name == 'workflow_dispatch' && inputs.run_freeze_registry || 
          github.event_name == 'pull_request' && false
        }}
      run_timelock_policy: >-
        ${{ 
          github.event_name == 'workflow_dispatch' && inputs.run_timelock_policy || 
          github.event_name == 'pull_request' && false
        }}
      run_threshold_policy: >-
        ${{ 
          github.event_name == 'workflow_dispatch' && inputs.run_threshold_policy || 
          github.event_name == 'pull_request' && false
        }}
      run_exchange: >-
        ${{ 
          github.event_name == 'workflow_dispatch' && inputs.run_exchange || 
          github.event_name == 'pull_request' && false
        }}
      run_sealed_report_token: >-
        ${{ 
          github.event_name == 'workflow_dispatch' && inputs.run_sealed_report_token || 
          github.event_name == 'pull_request' && false
        }}
      run_sealed_standalone_token: >-
        ${{ 
          github.event_name == 'workflow_dispatch' && inputs.run_sealed_standalone_token || 
          github.event_name == 'pull_request' && false
        }}
    steps:
      - run: echo "Determining which jobs to run"

  merkle-tree-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.run_merkle_tree == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Merkle Tree Test"
      test_command: "npm run test:select ./test/merkle_tree.test.ts"
      watched_paths: "programs/merkle_tree.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  report-policy-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.run_report_policy == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Report Policy Test"
      test_command: "npm run test:select ./test/report_policy.test.ts"
      watched_paths: "programs/sealed_report_policy.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  freeze-registry-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.run_freeze_registry == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Freeze Registry Test"
      test_command: "npm run test:select ./test/freeze_registry.test.ts"
      watched_paths: "programs/sealance_freezelist_registry.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  timelock-policy-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.run_timelock_policy == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Timelock Policy Test"
      test_command: "npm run test:select ./test/timelock.test.ts"
      watched_paths: "programs/sealed_timelock_policy.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  threshold-policy-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.run_threshold_policy == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Threshold Policy Test"
      test_command: "npm run test:select ./test/threshold.test.ts"
      watched_paths: "programs/sealed_threshold_report_policy.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  exchange-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.run_exchange == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Exchange Test"
      test_command: "npm run test:select ./test/exchange.test.ts"
      watched_paths: "programs/exchange.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  sealed-report-token-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.run_sealed_report_token == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Sealed Report Token Test"
      test_command: "npm run test:select ./test/report_token.test.ts"
      watched_paths: "programs/sealed_report_token.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit

  sealed-standalone-token-test:
    needs: check-trigger
    if: ${{ needs.check-trigger.outputs.run_sealed_standalone_token == 'true' }}
    uses: ./.github/workflows/reusable-aleo-test.yml
    with:
      job_name: "Sealed Standalone Token Test"
      test_command: "npm run test:select ./test/standalone_token.test.ts"
      watched_paths: "programs/sealed_standalone_token.leo,package.json,package-lock.json,aleo-config.js"
    secrets: inherit
