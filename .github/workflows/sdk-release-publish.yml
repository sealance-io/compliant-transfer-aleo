name: SDK Release - Publish

on:
  pull_request:
    types: [closed]
    branches:
      - main

# No default permissions - jobs must explicitly request what they need
permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # Never cancel publishing

jobs:
  # Gate: Only proceed if this is a merged release PR
  check-release:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Check if release PR
        id: check
        run: |
          # Primary check: source branch is changeset-release/main (canonical changesets pattern)
          # This is more robust than title matching since the branch name is deterministic
          if [[ "$PR_MERGED" == "true" && "$HEAD_REF" == "changeset-release/main" ]]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
            echo "Release PR detected (branch: $HEAD_REF) - proceeding to publish"
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
            echo "Not a release PR (merged=$PR_MERGED, branch=$HEAD_REF) - skipping"
          fi
        env:
          PR_MERGED: ${{ github.event.pull_request.merged }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}

      - name: Checkout
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          persist-credentials: false

      - name: Get package version
        if: steps.check.outputs.should_publish == 'true'
        id: version
        run: |
          VERSION=$(jq -r '.version' packages/policy-engine-sdk/package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

  # Publish to npm registry using OIDC (no token required)
  publish-npm:
    needs: check-release
    if: needs.check-release.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: npm-publish # Protected environment with required reviewers
    permissions:
      contents: read
      id-token: write # REQUIRED for npm OIDC trusted publishing
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          # cache: "npm"  # Disabled to prevent cache poisoning in release workflow
          node-version-file: ".nvmrc"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci --ignore-scripts --no-audit --no-fund

      - name: Build SDK
        run: npm run build --workspace=@sealance-io/policy-engine-aleo

      - name: Validate publish (dry-run)
        run: |
          echo "Running publish dry-run to validate package..."
          npm publish --workspace=@sealance-io/policy-engine-aleo --dry-run
          echo "Dry-run successful - package is valid for publishing"

      - name: Determine dist-tag
        id: dist-tag
        env:
          VERSION: ${{ needs.check-release.outputs.version }}
        run: |
          if [[ "$VERSION" == *"-alpha"* ]]; then
            echo "tag=alpha" >> $GITHUB_OUTPUT
            echo "Detected alpha pre-release: using 'alpha' dist-tag"
          elif [[ "$VERSION" == *"-beta"* ]]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
            echo "Detected beta pre-release: using 'beta' dist-tag"
          elif [[ "$VERSION" == *"-rc"* ]]; then
            echo "tag=rc" >> $GITHUB_OUTPUT
            echo "Detected release candidate: using 'rc' dist-tag"
          elif [[ "$VERSION" == *"-"* ]]; then
            echo "tag=next" >> $GITHUB_OUTPUT
            echo "Detected pre-release: using 'next' dist-tag"
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "Stable release: using 'latest' dist-tag"
          fi

      - name: Publish to npm (with retry)
        run: |
          TAG_FLAG=""
          if [[ "$DIST_TAG" != "latest" ]]; then
            TAG_FLAG="--tag $DIST_TAG"
            echo "Publishing with dist-tag: $DIST_TAG"
          fi

          for attempt in 1 2 3; do
            echo "Publish attempt $attempt of 3..."
            if npm publish --workspace=@sealance-io/policy-engine-aleo $TAG_FLAG; then
              echo "Successfully published to npm"
              exit 0
            fi
            if [[ $attempt -lt 3 ]]; then
              echo "Attempt $attempt failed, waiting 30s before retry..."
              sleep 30
            fi
          done
          echo "All publish attempts failed"
          exit 1
        env:
          DIST_TAG: ${{ steps.dist-tag.outputs.tag }}
        # NO NODE_AUTH_TOKEN - OIDC handles authentication automatically
        # Provenance attestation is enabled by default with OIDC

      - name: Verify npm publish
        run: |
          echo "Waiting for npm registry propagation..."
          sleep 15
          for attempt in 1 2 3; do
            echo "Verification attempt $attempt of 3..."
            if npm view @sealance-io/policy-engine-aleo@$VERSION version 2>/dev/null; then
              echo "Verified: package v$VERSION is available on npm"
              exit 0
            fi
            echo "Package not yet available, waiting 15s..."
            sleep 15
          done
          echo "::warning::Could not verify package availability (may still be propagating)"
          # Don't fail - package was published, just slow to propagate
        env:
          VERSION: ${{ needs.check-release.outputs.version }}

  # Publish to GitHub Packages (requires GITHUB_TOKEN, no OIDC support)
  # Non-blocking: npm is the primary registry, GitHub Packages is secondary
  publish-github:
    needs: [check-release, publish-npm]
    if: needs.check-release.outputs.should_publish == 'true'
    continue-on-error: true # Don't fail the release if GitHub Packages fails
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: github-packages # Separate environment for GitHub Packages
    permissions:
      contents: read
      packages: write # Required for GitHub Packages
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          # cache: "npm"  # Disabled to prevent cache poisoning in release workflow
          node-version-file: ".nvmrc"
          registry-url: "https://npm.pkg.github.com"
          scope: "@sealance-io"

      - name: Install dependencies
        run: npm ci --ignore-scripts --no-audit --no-fund

      - name: Build SDK
        run: npm run build --workspace=@sealance-io/policy-engine-aleo

      - name: Publish to GitHub Packages
        # zizmor: ignore[use-trusted-publishing] - GitHub Packages uses GITHUB_TOKEN (no OIDC alternative)
        run: npm publish --workspace=@sealance-io/policy-engine-aleo --registry=https://npm.pkg.github.com
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Create GitHub Release
  create-release:
    needs: [check-release, publish-npm, publish-github]
    if: needs.check-release.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write # Required for creating releases
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          persist-credentials: false

      - name: Create GitHub Release
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PACKAGE_VERSION: ${{ needs.check-release.outputs.version }}
        with:
          script: |
            const version = process.env.PACKAGE_VERSION;
            const tag = `@sealance-io/policy-engine-aleo@${version}`;

            // Create tag (idempotent - handle re-runs gracefully)
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tag}`,
                sha: context.sha
              });
              console.log(`Created tag ${tag}`);
            } catch (e) {
              if (e.status === 422 && e.message.includes('Reference already exists')) {
                console.log(`Tag ${tag} already exists (workflow re-run) - continuing`);
              } else {
                throw e;
              }
            }

            // Create release (idempotent - handle re-runs gracefully)
            try {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: `@sealance-io/policy-engine-aleo v${version}`,
                body: `See [CHANGELOG.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/packages/policy-engine-sdk/CHANGELOG.md) for details.\n\n**npm:** https://www.npmjs.com/package/@sealance-io/policy-engine-aleo/v/${version}`,
                draft: false,
                prerelease: version.includes('-')
              });
              console.log(`Created release for ${tag}`);
            } catch (e) {
              if (e.status === 422) {
                console.log(`Release for ${tag} already exists (workflow re-run) - continuing`);
              } else {
                throw e;
              }
            }

  # Rollup status for tracking
  release-status:
    name: Release Status
    needs: [check-release, publish-npm, publish-github, create-release]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions: {} # No permissions needed - just checks job results
    steps:
      - name: Check results
        run: |
          echo "::group::Job Results"
          echo "Should publish: $SHOULD_PUBLISH"
          echo "npm publish: $NPM_RESULT"
          echo "GitHub Packages: $GITHUB_OUTCOME (non-blocking)"
          echo "Release: $RELEASE_RESULT"
          echo "::endgroup::"

          if [[ "$SHOULD_PUBLISH" != "true" ]]; then
            echo "::notice::Not a release PR - skipped publishing"
            exit 0
          fi

          # npm publish is REQUIRED - this is the primary registry
          if [[ "$NPM_RESULT" != "success" ]]; then
            echo "::error::npm publish failed - release blocked"
            exit 1
          fi

          # GitHub Packages is NON-BLOCKING - warn but don't fail
          # Uses 'outcome' to see real result before continue-on-error was applied
          if [[ "$GITHUB_OUTCOME" != "success" ]]; then
            echo "::warning::GitHub Packages publish failed (non-critical) - users can still install from npm"
          fi

          # GitHub Release creation is REQUIRED
          if [[ "$RELEASE_RESULT" != "success" ]]; then
            echo "::error::GitHub Release creation failed"
            exit 1
          fi

          if [[ "$GITHUB_OUTCOME" == "success" ]]; then
            echo "::notice::Release completed successfully (npm + GitHub Packages + GitHub Release)"
          else
            echo "::notice::Release completed with warnings (npm + GitHub Release succeeded, GitHub Packages failed)"
          fi
        env:
          SHOULD_PUBLISH: ${{ needs.check-release.outputs.should_publish }}
          NPM_RESULT: ${{ needs.publish-npm.result }}
          GITHUB_OUTCOME: ${{ needs.publish-github.outcome }}
          RELEASE_RESULT: ${{ needs.create-release.result }}
