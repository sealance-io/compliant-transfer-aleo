# Dependabot Configuration for compliant-transfer-aleo
#
# This repository uses npm workspaces with a single root package-lock.json.
# The root workspace manages all dependencies for both the root package and
# the @sealance-io/policy-engine-aleo SDK in packages/policy-engine-sdk.
#
# Security note: This project uses lockfile-lint and npm ci with --ignore-scripts
# for supply chain attack prevention. See docs/NPM-SECURITY.md for details.

version: 2

# ============================================================================
# NPM PACKAGE ECOSYSTEM
# ============================================================================
# Configuration implements:
# - Patch and minor version updates only (major versions blocked)
# - Exact version installation (versioning-strategy: increase)
# - 7/3-day cooldown (minor/patch) per GitHub recommended defaults
# - Aggressive grouping (SDK deps excluded for individual review)
# - Special handling for patched dependencies (@doko-js/*)
# ============================================================================

updates:
  - package-ecosystem: "npm"
    directory: "/"

    # Daily checks maximize chances of catching releases post-cooldown; security updates trigger immediately
    schedule:
      interval: "daily"
      time: "09:00"
      timezone: "Etc/UTC"

    # CRITICAL: Always increase to exact versions, maintaining sync between
    # package.json and package-lock.json. This respects exact version installation
    # and prevents version range expansion (no ^ or ~ prefixes)
    versioning-strategy: increase

    # 7/3-day cooldown policy (GitHub recommended defaults)
    # Blocks ~80% of supply chain attacks while minimizing "stuck forever" bug risk
    # Security updates bypass cooldown automatically
    cooldown:
      default-days: 7 # Catch-all fallback for any unlisted update types
      semver-minor-days: 7 # 7-day waiting period for minor versions
      semver-patch-days: 3 # 3-day validation for patches
      include:
        - "*" # Apply cooldown to all dependencies

    # Simplified grouping: bundle all non-SDK dependencies into single PRs
    groups:
      # Security updates grouped for immediate visibility
      security-updates:
        applies-to: security-updates
        patterns:
          - "*"

      # All non-SDK dependencies grouped together (minor + patch only)
      # SDK dependencies (@provablehq/*, @scure/base) get individual PRs for careful review
      all-dependencies:
        applies-to: version-updates
        patterns:
          - "*"
        exclude-patterns:
          - "@provablehq/*" # SDK dep - review individually
          - "@scure/base" # SDK dep - review individually
          - "@doko-js/*" # Blocked anyway (patches)
        update-types:
          - "minor"
          - "patch"

    # BLOCKED: @doko-js packages - these use custom patches via patch-package
    # and should only be updated manually after verifying patch compatibility
    ignore:
      # Block @doko-js packages - custom fork with patches applied
      # Updates require manual verification of patch compatibility
      # See patches/ directory for applied patches
      - dependency-name: "@doko-js/core"
      - dependency-name: "@doko-js/utils"
      - dependency-name: "@doko-js/wasm"
      # Block ALL major version updates - require manual review
      # Security updates bypass this automatically
      - dependency-name: "*"
        update-types: ["version-update:semver-major"]

    # Conservative PR limit to avoid overwhelming CI
    open-pull-requests-limit: 5

    # Semantic commit messages for changelog generation
    commit-message:
      prefix: "chore(deps)"
      prefix-development: "chore(dev-deps)"

    # Labels for automated workflows and filtering
    labels:
      - "dependencies"

  # ============================================================================
  # GITHUB ACTIONS ECOSYSTEM
  # ============================================================================
  # Configuration implements:
  # - Full commit SHA pinning for immutability (security best practice)
  # - Automatic SHA updates with version comment maintenance
  # - Weekly update schedule with grouping
  # - Security-hardened against tag hijacking attacks
  #
  # Note: This project already uses SHA-pinned actions with version comments
  # (e.g., actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0)
  # Dependabot will automatically maintain both SHA and version comments
  # ============================================================================

  - package-ecosystem: "github-actions"
    directory: "/"

    # Weekly schedule balances security with update fatigue
    # Monday morning aligns with existing security-audit.yml schedule
    # and provides full week for incident response
    schedule:
      interval: "weekly"
      day: "monday"
      time: "09:00"
      timezone: "Etc/UTC"

    cooldown:
      default-days: 21 # Since sem-ver granular config not supported - sets a catch-all conservative 21 days wait

    # Dependabot automatically:
    # 1. Detects SHA-pinned actions (format: actions/checkout@abc123...def # v4.1.1)
    # 2. Updates SHA when new versions released
    # 3. Updates version comment alongside SHA (since October 2022)
    # No special configuration required - SHA pinning happens in workflow files

    # Group all Actions updates into single PR to reduce noise
    groups:
      github-actions-updates:
        patterns:
          - "*"
        # Separate major updates for careful review of potential breaking changes
        update-types:
          - "minor"
          - "patch"

    # Conservative PR limit for manual security verification
    # Each update should be reviewed for security implications
    open-pull-requests-limit: 5

    # Semantic commit messages
    commit-message:
      prefix: "ci"

    # Labels for automated workflows and filtering
    labels:
      - "dependencies"
